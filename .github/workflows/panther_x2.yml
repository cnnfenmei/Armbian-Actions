# Workflow Name
name: "Armbian Build CI"

# ====================================================================
#  TRIGGERS
#  Defines when this workflow will run.
# ====================================================================
on:
  schedule:
    - cron: '30 2 * * 2'
    
  workflow_dispatch:
    inputs:

      BOARD:
        type: choice
        description: 'Board'
        options:
        - panther-x2
        - som3588-cat
        - ufi001c
        - uz801
        - all
        default: 'all'

      RELEASE_CHOICE:
        type: choice
        description: "Which release(s) to build"
        options:
        - default_schedule
        - all
        - bookworm
        - bullseye
        - buster
        - focal
        - jammy
        - noble
        - oracular
        - plucky
        - sid
        - trixie
        default: 'default_schedule'

      DESKTOP:
        type: choice
        description: "Desktop environment"
        options:
        - minimal
        - server
        - gnome
        - budgie
        - cinnamon
        - i3-wm
        - kde-neon
        - kde-plasma
        - mate
        - xfce
        - xmonad
        - minimal_and_server
        default: 'minimal_and_server'

      DOCKER:
        type: choice
        description: "Build type: yes = Docker, no = Actions"
        required: false
        options: [ 'yes', 'no' ]
        default: 'no'
      
      NIGHTLY:
        description: "Build type: yes = Nightly, no = Stable"
        required: false
        options: [ 'yes', 'no' ]
        type: choice
        default: 'no'

      ROOTFS:
        type: choice
        description: "Root filesystem"
        options:
        - ext4
        - btrfs
        default: 'ext4'

# ====================================================================
#  PERMISSIONS & CONCURRENCY
# ====================================================================
permissions:
  contents: write
  pages: write

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  DEFAULT_SCHEDULE_RELEASES: "plucky noble trixie"
  ALL_RELEASES: "bookworm bullseye buster focal jammy noble oracular plucky sid trixie"
  BOARD: "panther-x2 som3588-cat ufi001c uz801"
  ARMBIAN_VERSION: "v24.11.0"  # 使用最新的稳定版本

# ====================================================================
#  JOBS
# ====================================================================
jobs:
  # ====================================================================
  # JOB 0: Prepare Build Parameters and Matrix 
  # ====================================================================
  Prepare_Build:
    name: "Prepare Build Parameters & Matrix"
    runs-on: ubuntu-latest
    outputs:
      BOARD_STRING: ${{ (github.event_name == 'schedule' || inputs.BOARD == 'all') && env.BOARD || inputs.BOARD }}
      DESKTOP: ${{ (github.event_name == 'schedule'|| inputs.DESKTOP == 'minimal_and_server') && '["minimal", "server"]' || format('["{0}"]', inputs.DESKTOP) }}
      DESKTOP_DISPLAY: ${{ github.event_name == 'schedule' && 'minimal, server' || inputs.DESKTOP }}
      NIGHTLY: ${{ github.event_name == 'schedule' && 'no' || inputs.NIGHTLY }}
      DOCKER: ${{ github.event_name == 'schedule' && 'no' || inputs.DOCKER }}
      ROOTFS: ${{ github.event_name == 'schedule' && 'ext4' || inputs.ROOTFS }}
      BOARD: ${{ steps.set_matrix.outputs.BOARD }}
      RELEASE: ${{ steps.set_matrix.outputs.RELEASE }}
      VERSION: ${{ steps.get_version.outputs.VERSION }}

    steps:
      - name: "Log effective parameters"
        run: |
          echo "--- Build Parameters ---"
          echo "Trigger: ${{ github.event_name }}"
          echo "Board: ${{ (github.event_name == 'schedule' || inputs.BOARD == 'all') && env.BOARD || inputs.BOARD }}"
          echo "Desktop: ${{ github.event_name == 'schedule' && '[\"minimal\", \"server\"]' || format('[\"{0}\"]', inputs.DESKTOP) }}"
          echo "NIGHTLY: ${{ github.event_name == 'schedule' && 'no' || inputs.NIGHTLY }}"
          echo "DOCKER: ${{ github.event_name == 'schedule' && 'no' || inputs.DOCKER }}"
          echo "ROOTFS: ${{ github.event_name == 'schedule' && 'ext4' || inputs.ROOTFS }}"
          echo "Armbian Version: ${{ env.ARMBIAN_VERSION }}"

      - name: "Checkout Armbian ${{ env.ARMBIAN_VERSION }}"
        uses: actions/checkout@v4
        with:
          repository: armbian/build
          ref: ${{ env.ARMBIAN_VERSION }}  # 使用指定版本标签
          path: build

      - name: "Get Armbian Version"
        id: get_version
        run: |
          # 首先尝试从 VERSION 文件获取，如果不存在则使用环境变量
          if [ -f "build/VERSION" ]; then
            VERSION=$(cat build/VERSION)
            echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
            echo "Armbian version from VERSION file: ${VERSION}"
          else
            # 从标签名提取版本号（移除 'v' 前缀）
            VERSION=${ARMBIAN_VERSION#v}
            echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
            echo "Armbian version from tag: ${VERSION}"
          fi

      - name: "Verify Armbian Version"
        run: |
          echo "验证 Armbian 版本: ${{ env.ARMBIAN_VERSION }}"
          cd build
          echo "当前 Git 标签:"
          git describe --tags || echo "无法获取标签信息"
          echo "当前提交:"
          git log -1 --oneline

      - name: "Set and Log Release Matrix"
        id: set_matrix
        run: |
          RELEASE_STRING=""
          if [[ "${{ github.event_name }}" == "schedule" || "${{ inputs.RELEASE_CHOICE }}" == "default_schedule" ]]; then
            RELEASE_STRING="${{ env.DEFAULT_SCHEDULE_RELEASES }}"
          elif [[ "${{ inputs.RELEASE_CHOICE }}" == "all" ]]; then
            RELEASE_STRING="${{ env.ALL_RELEASES }}"
          else
            RELEASE_STRING="${{ inputs.RELEASE_CHOICE }}"
          fi
          
          echo "Selected releases to build: ${RELEASE_STRING}"

          BOARD_STRING="${{ (github.event_name == 'schedule' || inputs.BOARD == 'all') && env.BOARD || inputs.BOARD }}"
          
          JSON_RELEASE=$(echo "${RELEASE_STRING}" | jq -c -R 'split(" ") | map(select(. != ""))')
          JSON_BOARD=$(echo "${BOARD_STRING}" | jq -c -R 'split(" ") | map(select(. != ""))')
          
          echo "RELEASE=${JSON_RELEASE}" >> $GITHUB_OUTPUT
          echo "BOARD=${JSON_BOARD}" >> $GITHUB_OUTPUT
          echo "--- Release Matrix Generated ---"
          echo "Matrix_RELEASE: ${JSON_RELEASE}"
          echo "Matrix_BOARD: ${JSON_BOARD}"

  # ====================================================================
  # JOB 1: Build Kernel Packages
  # ====================================================================
  Build_Kernel:
    needs: Prepare_Build
    name: "Build Kernel [${{ matrix.BOARD }} ${{ matrix.BRANCH }}]"
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    strategy:
      fail-fast: false
      matrix:
        BRANCH: [vendor]
        BOARD: ${{ fromJson(needs.Prepare_Build.outputs.BOARD) }}

    steps:
      - name: "Checkout Board Source"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: false
          path: custom

      - name: "Checkout Armbian ${{ env.ARMBIAN_VERSION }} Build System"
        uses: actions/checkout@v4
        with:
          repository: armbian/build
          ref: ${{ env.ARMBIAN_VERSION }}  # 使用指定版本
          clean: false
          path: build

      - name: "Checkout OS Source" 
        uses: actions/checkout@v4
        with:
          repository: armbian/os
          ref: main
          fetch-depth: 0
          clean: false
          path: os

      # ... 其余步骤保持不变 ...

  # ====================================================================
  # JOB 2: Build Armbian Image
  # ====================================================================
  Build_Image:
    name: "Build Image [${{ matrix.BOARD }} ${{ matrix.BRANCH }} ${{ matrix.RELEASE }} ${{ matrix.DESKTOP }}]"
    needs: [Prepare_Build, Build_Kernel]
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        BRANCH: [ vendor ]
        BOARD: ${{ fromJson(needs.Prepare_Build.outputs.BOARD) }} 
        RELEASE: ${{ fromJson(needs.Prepare_Build.outputs.RELEASE) }}
        DESKTOP: ${{ fromJson(needs.Prepare_Build.outputs.DESKTOP) }}
        
    steps:
      - name: "Checkout Board Source"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: false
          path: custom

      - name: "Checkout Armbian ${{ env.ARMBIAN_VERSION }} Build System"
        uses: actions/checkout@v4
        with:
          repository: armbian/build
          ref: ${{ env.ARMBIAN_VERSION }}  # 使用指定版本
          clean: false
          path: build

      # ... 其余步骤保持不变，确保所有 checkout 都使用指定版本 ...

      - name: "Upload Image to GitHub Release"
        uses: ncipollo/release-action@v1
        if: success()
        with:
          tag: "Armbian_${{ needs.Prepare_Build.outputs.VERSION }}"  # 使用实际版本号
          name: "Armbian ${{ needs.Prepare_Build.outputs.VERSION }}"
          artifacts: |
            build/output/images/*
          allowUpdates: true
          removeArtifacts: false
          replacesArtifacts: false 
          token: ${{ secrets.GITHUB_TOKEN }}

  # ====================================================================
  # JOB 3: Publish GitHub Release
  # ====================================================================
  Publish_Release:
    name: "Publish GitHub Release"
    runs-on: ubuntu-latest
    needs: [Prepare_Build, Build_Image]
    if: always() 

    steps:
      # ... 步骤保持不变，但更新版本引用 ...

      - name: "Delete Conflicting Kernel Assets from Release"
        continue-on-error: true
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: "Armbian_${{ needs.Prepare_Build.outputs.VERSION }}"  # 使用实际版本号
        run: |
          # ... 脚本内容保持不变 ...
